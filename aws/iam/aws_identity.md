# AWSのアカウント管理と権限付与
セキュアなシステムを開発・運用していくためには、アカウントやリソースの管理や、利用者への適切な権限付与の設計が必須。
## AWSのアカウント管理
AWS上で複数のシステムを構築・運用する場合、システム毎に複数のAWSアカウントを管理する。また、1つのシステムの中で環境毎（本番環境、テスト環境、開発環境）に分けるケースも多い。
### AWS Organizations
複数のアカウントをグループ化し、アカウント群の管理を一元的に行うサービス。グループにまとめることで、複数のアカウントの請求を束ねたり、アカウント毎に利用できるサービスに制限をかけることが可能。
Organization、Root、Organization Unit、アカウントの要素がある。
SCP（サービスコントロールポリシー）で利用できるサービス、操作に利用を制限をかけられる。

### ベストプラクティス
- マスターアカウントでCloudTrailを有効にする
- マスターアカウントはアカウント管理専用にする
- Organization Unitにサービスコントロールポリシーをアタッチして権限を制限する
- Organization内でホワイトリストとブラックリストを混在させない

### アカウント管理のロードマップ
- 管理主体と管理する範囲を決める
- 権限付与のルールを作成する
- Organization Unitの構成設計を行う

## AWSの環境分離
アカウントを分離する方法と同一アカウント内でVPCを分離する方法がある。
### 環境をアカウントで分割するメリット
- 運用面
分けることで権限管理がシンプルになる。
分けていない場合、AWSリソースが増える旅にIAMでの権限付与が必要で、管理が煩雑になる。
- コスト面
AWSアカウント単位でコストが請求されるため、1アカウント1請求先というシンプルな考え方にすることができる。
### 環境をアカウントで分割するデメリット
- 運用面
アカウント毎にIAMユーザーを作成する必要がある。
ただし、CloudFormationで自動化もできるためそこまでデメリットではない。
また、開発環境と本番環境で操作権限を微妙に変えるとうはやりやすい。
- コスト面
リソースの数が増えることによるコスト増、サポート料金のコスト増。
### ベストプラクティス
- システムや環境毎にアカウントを分ける
- 請求用アカウントは別途用意して、各アカウントの請求を一括でまとめる

上記の構成にすることで権限管理を簡潔に定義できる。
## AWSの権限管理
権限管理にはIAMを用いる。認証・認可はCognitoを用いる。
### IAM
- IAMポリシー
AWSサービスやAWSリソースに対する捜査権限をJSON形式で定義したもの。
Version、Effect、Action、Resourceの項目がある。
作成には新規でスクラッチ作成、AWS管理ポリシーをコピー、ポリシージェネレータを使う方法がある。
- IAMユーザー
AWSの操作を行うためのユーザーで利用者毎に払い出す必要がある。
IAMポリシーを与えて権限を付与。
- IAMグループ
同じ権限を与えたいIAMユーザーをひとまとめに管理する機能。
IAMポリシーを与えて権限を付与。
- IAMロール
リソース自体に操作権限を付与する仕組み。一時的にリソースにアクセスする権限を付与する。（EC2→S3）
キーペアを用いる方式と異なり、プログラムや設定ファイルに機密情報を埋め込む必要がない。
ユーザーにもアタッチ可能。
- クロスアカウントロール
あるアカウントのIAMユーザーでログイン時に、スイッチロール機能により、別アカウントのAWSリソースの操作権限を付与する機能。一時的にリソースにアクセスさせる時に使う。
### Cognito
IAMロールではAWSサービス上で動くプログラムからはキーペア情報を取り除けるが、ネイティブアプリケーション（iOS、Android）やブラウザ上で動くプログラムで使えない。
Cognitoはこのような場面で利用できるユーザーの認証・認可を行うフルマネージドサービス。認証成功ユーザーに一時キーを払い出し、AWSリソースへの操作権限を与える。

### ベストプラクティス
- 役割毎のIAMグループで権限を管理する
- 利用者ごとにIAMユーザーを払い出す
- 割り当てる権限は必要最低限のものにする
- 権限やIAMユーザーについては定期的に棚卸しし、最適な情報を保つ
